@model List<Trendify.Models.Product>
@{
    ViewData["Title"] = "Products - Trendify";
    var categories = ViewBag.Categories as List<Trendify.Models.Category>;
    var selectedCategory = ViewBag.SelectedCategory as int?;
    var searchTerm = ViewBag.SearchTerm as string;
}
<style>
    .product-image-container {
        position: relative;
        overflow: hidden;
        background: #f8f9fa;
        width: 100%;
        aspect-ratio: 1 / 1; /* Perfect square ratio */
    }

    .product-list-image {
        width: 100%;
        height: 100%;
        object-fit: cover; /* Fill container without distortion */
        object-position: center;
        transition: transform 0.3s ease;
    }

    .product-card:hover .product-list-image {
        transform: scale(1.05);
    }

    .featured-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: #ffc107;
        color: #000;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
        z-index: 2;
    }

    .out-of-stock-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        z-index: 1;
    }

    /* Ensure consistent card heights */
    .product-card {
        display: flex;
        flex-direction: column;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
        }

        .product-card .card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .product-card .card-footer {
            flex-shrink: 0;
        }

    /* Text styling for better consistency */
    .card-title {
        font-size: 1rem;
        font-weight: 600;
        line-height: 1.3;
        margin-bottom: 0.5rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        min-height: 2.6rem;
    }

    .card-text {
        font-size: 0.85rem;
        margin-bottom: 1rem;
    }

    /* Responsive adjustments */
    @@media (max-width: 768px) {
        .product-image-container {
            aspect-ratio: 4/3; /* Slightly wider on mobile */
        }

        .card-title {
            font-size: 0.9rem;
            min-height: 2.4rem;
        }
    }
</style>

<div class="container mt-4">
    <div class="row">
        <!-- Sidebar Filters -->
        <div class="col-lg-3 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Filters</h5>
                </div>
                <div class="card-body">
                    <!-- Categories -->
                    <h6>Categories</h6>
                    <div class="list-group list-group-flush">
                        <a href="@Url.Action("Index", "Products")"
                           class="list-group-item list-group-item-action @(selectedCategory == null ? "active" : "")">
                            All Categories
                        </a>
                        @if (categories != null)
                        {
                            @foreach (var category in categories)
                            {
                                <a href="@Url.Action("Index", "Products", new { categoryId = category.Id })"
                                   class="list-group-item list-group-item-action @(selectedCategory == category.Id ? "active" : "")">
                                    @category.Name <span class="badge bg-secondary float-end">@category.Products.Count</span>
                                </a>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Grid -->
        <div class="col-lg-9">
            <!-- Search and Sort Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">
                        @if (!string.IsNullOrEmpty(searchTerm))
                        {
                            <span>Search Results for "@searchTerm"</span>
                        }
                        else if (selectedCategory.HasValue)
                        {
                            var category = categories?.FirstOrDefault(c => c.Id == selectedCategory.Value);
                            <span>@category?.Name</span>
                        }
                        else
                        {
                            <span>All Products</span>
                        }
                    </h2>
                    <p class="text-muted mb-0">@Model.Count products found</p>
                </div>
                <div class="d-flex">
                    <form class="d-flex me-2" asp-controller="Products" asp-action="Index" method="get">
                        <input class="form-control" type="search" name="search" value="@searchTerm" placeholder="Search products...">
                        <button class="btn btn-outline-primary ms-2" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Products Grid -->
            <div class="row g-4">
                @if (Model != null && Model.Any())
                {
                    @foreach (var product in Model)
                    {
                        <div class="col-xl-4 col-lg-6 col-md-6">
                            <div class="card product-card h-100 border-0 shadow-sm">
                                <!-- Product Image from Database -->
                                <div class="product-image-container">
                                    <img src="@product.ImageUrl" class="product-list-image" alt="@product.Name"
                                         onerror="this.onerror=null; this.src='/images/products/default.jpg'">
                                    @if (product.IsFeatured)
                                    {
                                        <span class="featured-badge">Featured</span>
                                    }
                                    @if (product.StockQuantity <= 0)
                                    {
                                        <div class="out-of-stock-overlay">
                                            <span>Out of Stock</span>
                                        </div>
                                    }
                                </div>
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">@product.Name</h5>
                                    <p class="card-text text-muted small">@product.Brand - @product.Category.Name</p>
                                    <div class="mt-auto">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="h5 text-primary mb-0">$@product.Price.ToString("0.00")</span>
                                            @if (product.StockQuantity > 0)
                                            {
                                                <span class="badge bg-success">In Stock</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger">Out of Stock</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent border-0">
                                    <div class="d-grid gap-2">
                                        <a href="@Url.Action("Details", "Products", new { id = product.Id })" class="btn btn-outline-primary btn-sm">View Details</a>
                                        @if (product.StockQuantity > 0 && User.Identity.IsAuthenticated)
                                        {
                                            <form asp-controller="Cart" asp-action="AddToCart" method="post">
                                                <input type="hidden" name="productId" value="@product.Id" />
                                                <input type="hidden" name="quantity" value="1" />
                                                <button type="submit" class="btn btn-primary btn-sm w-100">
                                                    <i class="fas fa-shopping-cart me-2"></i>Add to Cart
                                                </button>
                                            </form>
                                        }
                                        else if (!User.Identity.IsAuthenticated)
                                        {
                                            <a href="/Identity/Account/Login" class="btn btn-primary btn-sm w-100">
                                                <i class="fas fa-shopping-cart me-2"></i>Login to Buy
                                            </a>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h4>No products found</h4>
                        <p class="text-muted">Try adjusting your search or filter criteria.</p>
                        <a href="@Url.Action("Index", "Products")" class="btn btn-primary">View All Products</a>
                    </div>
                }
            </div>
        </div>
    </div>
</div>